<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Trainer V5 (Mobile)</title>
    
    <!-- LIBRARIES -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <style>
        /* --- RESET & BASE --- */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #121212; color: #e0e0e0; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            user-select: none;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 15px; background: #1e1e1e; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; flex-shrink: 0; height: 50px;
        }
        h2 { margin: 0; font-size: 1.1rem; color: #81b64c; }
        .stats { font-family: monospace; background: #333; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }

        /* --- MAIN SCROLL AREA --- */
        .main-content {
            flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; align-items: center;
            padding-bottom: 80px; /* Space for bottom bar */
        }

        /* --- BOARD --- */
        #board-container { width: 100%; max-width: 450px; margin-bottom: 10px; }
        #myBoard { width: 100%; touch-action: none; }
        
        .eval-bar-wrapper { width: 100%; height: 6px; background: #333; margin-bottom: 5px; border-radius: 3px; overflow: hidden; }
        .eval-bar { height: 100%; width: 50%; background: #eee; transition: width 0.5s; }

        /* --- STATUS & HISTORY --- */
        #status { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; text-align: center; min-height: 1.2em; }
        
        .settings-box {
            width: 100%; max-width: 450px; background: #1e1e1e; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        .row { display: flex; gap: 10px; margin-bottom: 8px; }
        .col { flex: 1; }
        label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 2px; text-transform: uppercase; }
        select { width: 100%; background: #333; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; }

        .history-box {
            width: 100%; max-width: 450px; height: 100px; background: #1e1e1e; padding: 5px; 
            overflow-y: auto; border-radius: 8px; font-family: monospace; font-size: 0.85rem;
        }
        #moveList { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 5px; }
        #moveList li { padding: 2px 6px; background: #2a2a2a; border-radius: 3px; }
        
        /* --- BOTTOM FLOATING BAR --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #1e1e1e; border-top: 1px solid #333;
            display: flex; align-items: center; padding: 0 10px; gap: 10px;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }
        
        .btn {
            flex: 1; border: none; border-radius: 6px; padding: 12px 0;
            font-weight: bold; font-size: 0.9rem; cursor: pointer; color: #fff;
            display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        
        .btn-undo { background: #d32f2f; }
        .btn-hint { background: #f57c00; }
        .btn-start { background: #81b64c; color: #121212; flex: 1.5; }

        /* --- VISUALS --- */
        .highlight-last { background-color: rgba(255, 255, 0, 0.4) !important; }
        .highlight-check { background-color: rgba(255, 0, 0, 0.6) !important; }
        .error-flash { animation: flashRed 0.3s; }
        @keyframes flashRed { 50% { box-shadow: 0 0 20px 10px rgba(244, 67, 54, 0.5); } }
        .res-best { color: #81b64c; border: 1px solid #81b64c; }
        .res-neutral { color: #aaa; border: 1px solid #444; }

    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <h2>‚ôüÔ∏è Trainer V5</h2>
        <div class="stats" id="statsDisplay">0%</div>
    </header>

    <!-- Scrollable Content -->
    <div class="main-content">
        <div id="board-container">
            <div class="eval-bar-wrapper"><div id="evalBar" class="eval-bar"></div></div>
            <div id="myBoard"></div>
        </div>

        <div id="status">Initializing Engine...</div>

        <div class="settings-box">
            <div class="row">
                <div class="col">
                    <label>Opening</label>
                    <select id="openingSelect"></select>
                </div>
                <div class="col">
                    <label>Mode</label>
                    <select id="modeSelect">
                        <option value="drill">Strict Drill</option>
                        <option value="play">Free Play</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>Color</label>
                    <select id="colorSelect">
                        <option value="white">White</option>
                        <option value="black">Black</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="history-box">
            <ul id="moveList"></ul>
        </div>
    </div>

    <!-- Fixed Bottom Bar -->
    <div class="bottom-bar">
        <button id="undoBtn" class="btn btn-undo">‚Ü© Undo</button>
        <button id="hintBtn" class="btn btn-hint">üí° Hint</button>
        <button id="startBtn" class="btn btn-start">New Game</button>
    </div>

<script>
/* --- 1. SOUNDS --- */
const sounds = {
    move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/move-self.mp3'),
    capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/capture.mp3'),
    error: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/illegal.mp3'),
    notify: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/notify.mp3')
};
function playSound(key) {
    if(sounds[key]) {
        sounds[key].currentTime = 0;
        sounds[key].play().catch(() => {});
    }
}

/* --- 2. OPENINGS --- */
const openings = {
    "Italian Game": { name: "Italian Game", moves: ["e4", "e5", "Nf3", "Nc6", "Bc4"], desc: "Center Control" },
    "Ruy Lopez": { name: "Ruy Lopez", moves: ["e4", "e5", "Nf3", "Nc6", "Bb5"], desc: "Spanish Game" },
    "Sicilian Defense": { name: "Sicilian Defense", moves: ["e4", "c5", "Nf3", "d6", "d4", "cxd4", "Nxd4"], desc: "Fighting Defense" },
    "French Defense": { name: "French Defense", moves: ["e4", "e6", "d4", "d5"], desc: "Solid Structure" },
    "London System": { name: "London System", moves: ["d4", "d5", "Bf4"], desc: "White System" },
    "Queen's Gambit": { name: "Queen's Gambit", moves: ["d4", "d5", "c4"], desc: "Pawn Sacrifice" }
};

/* --- 3. STATE --- */
var board, game = new Chess(), stockfish;
var currentOpening = null, moveIndex = 0, playerColor = 'white', gameMode = 'drill';
var stats = { correct: 0, total: 0 };

/* --- 4. ENGINE --- */
const stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js';
fetch(stockfishUrl).then(r=>r.text()).then(txt => {
    var blob = new Blob([txt], {type: 'application/javascript'});
    stockfish = new Worker(URL.createObjectURL(blob));
    stockfish.postMessage('uci');
    stockfish.postMessage('setoption name Skill Level value 1'); 
    stockfish.onmessage = (e) => {
        if(e.data.startsWith('bestmove') && game.turn() !== playerColor[0]) {
            var m = e.data.split(' ')[1];
            setTimeout(() => makeEngineMove(m.substring(0,2), m.substring(2,4)), 300);
        }
        if(e.data.includes('cp ')) updateEval(e.data);
    };
    document.getElementById('status').innerText = "Engine Ready. Press New Game.";
    loadStats();
});

/* --- 5. LOGIC --- */
function init() {
    var sel = document.getElementById('openingSelect');
    for(var k in openings) {
        var opt = document.createElement('option');
        opt.value = k; opt.innerText = k; sel.appendChild(opt);
    }
    window.addEventListener('resize', () => { if(board) board.resize(); });
    $('#myBoard').on('touchmove', (e) => e.preventDefault());
    
    // Button Bindings
    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('undoBtn').onclick = undoMove;
    document.getElementById('hintBtn').onclick = showHint;
}

function startGame() {
    game.reset();
    playerColor = document.getElementById('colorSelect').value;
    gameMode = document.getElementById('modeSelect').value;
    currentOpening = openings[document.getElementById('openingSelect').value];
    moveIndex = 0;
    
    document.getElementById('moveList').innerHTML = '';
    updateStatus();
    removeHighlights();
    sounds.notify.play();

    if(board) board.destroy();
    board = Chessboard('myBoard', {
        draggable: true,
        position: 'start',
        orientation: playerColor,
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: () => board.position(game.fen()),
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
    });

    if(playerColor === 'black') setTimeout(playBookMove, 500);
}

function onDragStart(source, piece) {
    if(game.game_over()) return false;
    if((playerColor === 'white' && piece.search(/^b/) !== -1) || 
       (playerColor === 'black' && piece.search(/^w/) !== -1)) return false;
}

function onDrop(source, target) {
    if(game.game_over()) return false;
    
    // Dry run
    var tempGame = new Chess(game.fen());
    var tempMove = tempGame.move({from:source, to:target, promotion:'q'});
    if(!tempMove) return 'snapback';

    // Drill Check
    if(gameMode === 'drill' && moveIndex < currentOpening.moves.length) {
        if(tempMove.san !== currentOpening.moves[moveIndex]) {
            triggerError(currentOpening.moves[moveIndex]);
            return 'snapback';
        }
    }

    // Execute
    var move = game.move({from:source, to:target, promotion:'q'});
    playSound(move.flags.includes('c') ? 'capture' : 'move');
    highlightMove(source, target);
    
    // Log
    if(moveIndex < currentOpening.moves.length) {
        logMove(move.san, 'res-best');
        moveIndex++;
        stats.correct++;
    } else {
        logMove(move.san, 'res-neutral');
    }
    saveStats();
    updateStatus();

    // Reply
    if(!game.game_over()) {
        if(moveIndex < currentOpening.moves.length) setTimeout(playBookMove, 500);
        else {
            stockfish.postMessage(`position fen ${game.fen()}`);
            stockfish.postMessage('go depth 6');
        }
    }
}

function playBookMove() {
    if(moveIndex < currentOpening.moves.length) {
        var m = currentOpening.moves[moveIndex];
        var move = game.move(m);
        board.position(game.fen());
        playSound(move.flags.includes('c') ? 'capture' : 'move');
        highlightMove(move.from, move.to);
        moveIndex++;
        logMove(m, 'res-neutral');
    }
}

function makeEngineMove(from, to) {
    var move = game.move({from:from, to:to, promotion:'q'});
    if(move) {
        board.position(game.fen());
        playSound(move.flags.includes('c') ? 'capture' : 'move');
        highlightMove(from, to);
        updateStatus();
    }
}

function undoMove() {
    game.undo(); game.undo();
    board.position(game.fen());
    removeHighlights();
    if(moveIndex > 0) moveIndex--;
    
    var list = document.getElementById('moveList');
    if(list.children.length > 0) list.removeChild(list.firstChild);
    if(list.children.length > 0) list.removeChild(list.firstChild);
    
    document.getElementById('status').innerText = "Undone.";
}

/* --- HELPERS --- */
function triggerError(expected) {
    playSound('error');
    document.getElementById('status').innerHTML = `<b style="color:#f44336">WRONG!</b> Book move: ${expected}`;
    $('#myBoard').addClass('error-flash');
    setTimeout(()=>$('#myBoard').removeClass('error-flash'), 300);
    stats.total++; saveStats();
}

function highlightMove(from, to) {
    $('.square-55d63').removeClass('highlight-last');
    $('.square-'+from).addClass('highlight-last');
    $('.square-'+to).addClass('highlight-last');
}
function removeHighlights() { $('.square-55d63').removeClass('highlight-last'); }

function updateStatus() {
    var msg = game.in_checkmate() ? "Checkmate!" : (game.in_check() ? "Check!" : "Your Turn");
    if(moveIndex < currentOpening.moves.length) msg += ` (Book: ${currentOpening.name})`;
    document.getElementById('status').innerText = msg;
}

function logMove(san, cls) {
    var li = document.createElement('li');
    li.className = cls; li.innerText = san;
    document.getElementById('moveList').prepend(li);
}

function updateEval(data) {
    var parts = data.split(' ');
    var idx = parts.indexOf('cp');
    if(idx !== -1) {
        var cp = parseInt(parts[idx+1]);
        if(game.turn() === 'b') cp = -cp;
        var pct = 50 + (cp/15);
        pct = Math.max(5, Math.min(95, pct));
        if(playerColor==='black') pct = 100 - pct;
        document.getElementById('evalBar').style.width = pct + '%';
    }
}

function showHint() {
    if(moveIndex < currentOpening.moves.length) alert(`Book Move: ${currentOpening.moves[moveIndex]}`);
    else alert("Out of book!");
}

function saveStats() {
    localStorage.setItem('chessStatsV5', JSON.stringify(stats));
    loadStats();
}
function loadStats() {
    var saved = localStorage.getItem('chessStatsV5');
    if(saved) stats = JSON.parse(saved);
    var rate = stats.total===0 ? 0 : Math.round((stats.correct/stats.total)*100);
    document.getElementById('statsDisplay').innerText = rate + "%";
}

init();
</script>
</body>
</html>
