<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Chess Trainer</title>
    
    <!-- CSS for Chessboard -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <style>
        /* --- MOBILE OPTIMIZED STYLES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        h2 {
            color: #81b64c;
            margin: 5px 0;
            font-size: 1.5rem;
            text-align: center;
        }

        /* BOARD */
        #myBoard {
            width: 100%;
            touch-action: none; /* Vital for mobile dragging */
            margin-bottom: 10px;
        }

        /* STATUS BOX */
        .status-card {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 6px;
            border-left: 5px solid #81b64c;
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* CONTROLS */
        .controls {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        label {
            display: block;
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, button {
            width: 100%;
            padding: 12px;
            background: #333;
            color: white;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 1rem;
            -webkit-appearance: none; /* Fix for iOS Safari styling */
        }

        button {
            background: #81b64c;
            color: #121212;
            border: none;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        button:active { opacity: 0.8; transform: scale(0.98); }
        .btn-secondary { background: #444; color: #fff; }

        /* HISTORY */
        .history-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .stats-bar {
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        #moveList {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        #moveList li {
            font-family: monospace;
            font-size: 0.9rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: #2a2a2a;
        }

        .correct { color: #81b64c; border: 1px solid #81b64c; }
        .incorrect { color: #ff5252; border: 1px solid #ff5252; text-decoration: line-through; }
        .neutral { color: #aaa; }

    </style>
</head>
<body>

<div class="container">
    <h2>♟️ Opening Trainer</h2>

    <div id="myBoard"></div>

    <div class="status-card" id="status">
        Initializing Engine... Please wait.
    </div>

    <div class="controls">
        <div class="row">
            <div class="col">
                <label>Opening</label>
                <select id="openingSelect"></select>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <label>Color</label>
                <select id="colorSelect">
                    <option value="white">White</option>
                    <option value="black">Black</option>
                </select>
            </div>
            <div class="col">
                <label>Mode</label>
                <select id="modeSelect">
                    <option value="fixed">Fixed Lines</option>
                    <option value="variations">Play Engine</option>
                </select>
            </div>
        </div>

        <button id="startBtn">New Game</button>

        <div class="row">
            <div class="col">
                <button id="flipBtn" class="btn-secondary">Flip Board</button>
            </div>
            <div class="col">
                <button id="hintBtn" class="btn-secondary">Hint</button>
            </div>
        </div>
    </div>

    <div class="history-container">
        <div class="stats-bar">
            Success Rate: <span id="successRate">0%</span>
        </div>
        <ul id="moveList"></ul>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
/** 
 * DATA: Opening Repertoire 
 */
const openings = {
    "Italian Game": { 
        name: "Italian Game", 
        moves: ["e4", "e5", "Nf3", "Nc6", "Bc4"], 
        desc: "Controls center, eyes f7 weak point." 
    },
    "Ruy Lopez": { 
        name: "Ruy Lopez", 
        moves: ["e4", "e5", "Nf3", "Nc6", "Bb5"], 
        desc: "Puts pressure on the defender of e5." 
    },
    "Sicilian Defense": { 
        name: "Sicilian Defense", 
        moves: ["e4", "c5", "Nf3", "d6", "d4", "cxd4", "Nxd4"], 
        desc: "Aggressive counter-attack for Black." 
    },
    "French Defense": { 
        name: "French Defense", 
        moves: ["e4", "e6", "d4", "d5"], 
        desc: "Solid, counter-attacking structure." 
    },
    "Queen's Gambit": { 
        name: "Queen's Gambit", 
        moves: ["d4", "d5", "c4"], 
        desc: "White sacrifices a pawn for center control." 
    },
    "London System": { 
        name: "London System", 
        moves: ["d4", "d5", "Bf4"], 
        desc: "System opening, very solid." 
    }
};

/** 
 * ENGINE SETUP 
 * Loads Stockfish from CDN into a Blob to bypass CORS on GitHub Pages
 */
var stockfish = null;
var isEngineReady = false;
const stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js';

fetch(stockfishUrl)
    .then(response => response.text())
    .then(scriptContent => {
        const blob = new Blob([scriptContent], { type: 'application/javascript' });
        stockfish = new Worker(URL.createObjectURL(blob));
        
        // Engine Settings for ~800 ELO
        stockfish.postMessage('uci');
        stockfish.postMessage('setoption name Skill Level value 0'); // Level 0 is lowest (approx 800-1000)
        stockfish.postMessage('setoption name UCI_LimitStrength value true');
        stockfish.postMessage('setoption name UCI_Elo value 800');
        
        // Listen for moves
        stockfish.onmessage = function(event) {
            if (event.data.startsWith('bestmove')) {
                var bestMove = event.data.split(' ')[1];
                // Small delay to feel natural
                setTimeout(() => {
                    game.move({ from: bestMove.substring(0, 2), to: bestMove.substring(2, 4), promotion: 'q' });
                    board.position(game.fen());
                    updateStatus();
                }, 500);
            }
        };
        
        isEngineReady = true;
        document.getElementById('status').innerHTML = "Engine Ready! Select options and click New Game.";
    })
    .catch(err => {
        console.error(err);
        document.getElementById('status').innerHTML = "Error loading engine. Check internet.";
    });


/** 
 * GAME VARIABLES & LOGIC 
 */
var board = null;
var game = new Chess();
var currentOpening = null;
var playerColor = 'white';
var gameMode = 'fixed';
var moveIndex = 0;
var correctMoves = 0;
var totalMoves = 0;

function init() {
    // Populate Dropdown
    const selector = document.getElementById('openingSelect');
    for (let key in openings) {
        let opt = document.createElement('option');
        opt.value = key;
        opt.innerHTML = key;
        selector.appendChild(opt);
    }
    
    // Window Resize Handler
    window.addEventListener('resize', function() {
        if(board) board.resize();
    });

    // Prevent scrolling on board touch
    $('#myBoard').on('touchmove', function(e) {
        e.preventDefault();
    });
}

function startGame() {
    if (!isEngineReady) { 
        alert("Engine is loading..."); 
        return; 
    }

    // Reset State
    game.reset();
    playerColor = document.getElementById('colorSelect').value;
    gameMode = document.getElementById('modeSelect').value;
    let openingKey = document.getElementById('openingSelect').value;
    currentOpening = openings[openingKey];
    moveIndex = 0;
    correctMoves = 0; 
    totalMoves = 0;
    
    // UI Updates
    document.getElementById('moveList').innerHTML = '';
    document.getElementById('successRate').innerText = "0%";
    updateStatus(`<b>Starting ${currentOpening.name}</b><br>${currentOpening.desc}`);

    // Board Config
    var config = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        orientation: playerColor
    };
    
    if (board) board.destroy();
    board = Chessboard('myBoard', config);

    // If Computer is White
    if (playerColor === 'black') {
        setTimeout(playComputerMove, 500);
    }
}

function onDragStart(source, piece) {
    if (game.game_over()) return false;
    // Only pick up own pieces
    if ((playerColor === 'white' && piece.search(/^b/) !== -1) ||
        (playerColor === 'black' && piece.search(/^w/) !== -1)) {
        return false;
    }
}

function onDrop(source, target) {
    // Attempt move
    var move = game.move({
        from: source,
        to: target,
        promotion: 'q'
    });

    // Illegal move
    if (move === null) return 'snapback';

    // Valid move played
    checkTraining(move);
    updateStatus();

    // Computer Response
    if (!game.game_over()) {
        if (gameMode === 'fixed' && moveIndex < currentOpening.moves.length) {
            // Book Move
            setTimeout(playComputerMove, 250);
        } else {
            // Engine Move
            makeEngineMove();
        }
    }
}

function onSnapEnd() {
    board.position(game.fen());
}

function checkTraining(move) {
    let playedMove = move.san;
    
    // Are we still in the opening book?
    if (moveIndex < currentOpening.moves.length) {
        let expected = currentOpening.moves[moveIndex];
        
        if (playedMove === expected) {
            logMove(playedMove, "correct");
            moveIndex++;
            correctMoves++;
        } else {
            // WRONG MOVE
            updateStatus(`<b>Mistake!</b> Book move was: ${expected}`);
            logMove(playedMove, "incorrect");
            
            if (gameMode === 'fixed') {
                game.undo(); // Take it back
                return;
            }
        }
    } else {
        logMove(playedMove, "neutral");
    }
    
    // Update Stats
    totalMoves++;
    let rate = Math.round((correctMoves / totalMoves) * 100);
    if(totalMoves > 0) document.getElementById('successRate').innerText = rate + "%";
}

function playComputerMove() {
    if (moveIndex < currentOpening.moves.length) {
        let bookMove = currentOpening.moves[moveIndex];
        game.move(bookMove);
        board.position(game.fen());
        moveIndex++;
        logMove(bookMove, "neutral");
    } else {
        makeEngineMove();
    }
}

function makeEngineMove() {
    stockfish.postMessage('position fen ' + game.fen());
    stockfish.postMessage('go depth 5'); // Depth 5 is fast and low ELO
}

function updateStatus(msg) {
    var status = msg || '';
    var moveColor = (game.turn() === 'b') ? 'Black' : 'White';

    if (game.in_checkmate()) {
        status = `Checkmate! ${moveColor} lost.`;
    } else if (game.in_draw()) {
        status = 'Draw.';
    } else if (!msg) {
        status = `${moveColor} to move.`;
        if (game.in_check()) status += ' (Check!)';
    }
    document.getElementById('status').innerHTML = status;
}

function logMove(move, type) {
    let list = document.getElementById('moveList');
    let li = document.createElement('li');
    li.className = type;
    li.innerText = move;
    list.prepend(li); // Add to top
}

// Button Events
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('flipBtn').addEventListener('click', () => board.flip());
document.getElementById('hintBtn').addEventListener('click', () => {
    if(moveIndex < currentOpening.moves.length) {
        alert(`Book Move: ${currentOpening.moves[moveIndex]}`);
    } else {
        alert("You are on your own!");
    }
});

// Run Init
init();

</script>
</body>
</html>
