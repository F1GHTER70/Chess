<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Chess Trainer v2</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212; color: #e0e0e0; margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; }
        h2 { color: #81b64c; margin: 5px 0; font-size: 1.5rem; text-align: center; }
        
        /* Board & Indicators */
        #myBoard { width: 100%; touch-action: none; margin-bottom: 5px; }
        
        .eval-bar-container {
            width: 100%; height: 10px; background: #444; border-radius: 5px; overflow: hidden; margin-bottom: 10px; position: relative;
        }
        .eval-bar {
            height: 100%; background: #fff; width: 50%; transition: width 0.5s ease;
        }

        /* Status */
        .status-card {
            background: #2a2a2a; padding: 12px; border-radius: 6px; border-left: 5px solid #81b64c;
            font-size: 0.95rem; margin-bottom: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Controls */
        .controls {
            background: #1e1e1e; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; gap: 12px;
        }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 4px; text-transform: uppercase; }
        select, button {
            width: 100%; padding: 12px; background: #333; color: white; border: 1px solid #444; border-radius: 6px; font-size: 1rem;
            -webkit-appearance: none;
        }
        button { background: #81b64c; color: #121212; border: none; font-weight: bold; }
        button:active { opacity: 0.8; transform: scale(0.98); }
        .btn-secondary { background: #444; color: #fff; }
        .btn-danger { background: #d32f2f; color: #fff; }

        /* History & Labels */
        .history-container {
            background: #1e1e1e; border-radius: 8px; padding: 10px; max-height: 150px; overflow-y: auto;
        }
        #moveList { list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 8px; }
        #moveList li { font-family: monospace; font-size: 0.9rem; padding: 3px 6px; border-radius: 3px; background: #2a2a2a; display: flex; align-items: center; gap: 4px;}
        
        .label-best { color: #81b64c; font-weight: bold; }      /* !! */
        .label-good { color: #4caf50; }                         /* ✓ */
        .label-inaccuracy { color: #ff9800; }                   /* ?! */
        .label-blunder { color: #f44336; font-weight: bold; }   /* ?? */
    </style>
</head>
<body>

<div class="container">
    <h2>♟️ Pro Trainer v2</h2>
    
    <div class="eval-bar-container">
        <div id="evalBar" class="eval-bar"></div>
    </div>

    <div id="myBoard"></div>

    <div class="status-card" id="status">Initializing Engine...</div>

    <div class="controls">
        <div class="row">
            <div class="col"><button id="undoBtn" class="btn-secondary">Undo</button></div>
            <div class="col"><button id="startBtn">New Game</button></div>
        </div>
        
        <div class="row">
            <div class="col">
                <label>Opening</label>
                <select id="openingSelect"></select>
            </div>
            <div class="col">
                <label>Color</label>
                <select id="colorSelect">
                    <option value="white">White</option>
                    <option value="black">Black</option>
                </select>
            </div>
        </div>
    </div>

    <div class="history-container">
        <ul id="moveList"></ul>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
// --- DATA ---
const openings = {
    "Italian Game": { name: "Italian Game", moves: ["e4", "e5", "Nf3", "Nc6", "Bc4"], desc: "Center control, eyes f7." },
    "Ruy Lopez": { name: "Ruy Lopez", moves: ["e4", "e5", "Nf3", "Nc6", "Bb5"], desc: "Pressure on e5 defender." },
    "Sicilian Defense": { name: "Sicilian Defense", moves: ["e4", "c5", "Nf3", "d6", "d4", "cxd4", "Nxd4"], desc: "Aggressive counter." },
    "French Defense": { name: "French Defense", moves: ["e4", "e6", "d4", "d5"], desc: "Solid structure." },
    "London System": { name: "London System", moves: ["d4", "d5", "Bf4"], desc: "Solid system." }
};

// --- VARIABLES ---
var board = null;
var game = new Chess();
var stockfish = null;
var currentOpening = null;
var playerColor = 'white';
var moveIndex = 0;
var isEngineReady = false;
var prevEval = 0.3; // Start near equal

// --- ENGINE SETUP ---
const stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js';
fetch(stockfishUrl).then(r => r.text()).then(script => {
    const blob = new Blob([script], { type: 'application/javascript' });
    stockfish = new Worker(URL.createObjectURL(blob));
    
    stockfish.postMessage('uci');
    stockfish.postMessage('setoption name Skill Level value 0'); 
    stockfish.postMessage('setoption name UCI_Elo value 800');
    
    stockfish.onmessage = (event) => {
        if(event.data.startsWith('bestmove') && game.turn() !== playerColor.charAt(0)) {
            // Engine Move Response
            var bestMove = event.data.split(' ')[1];
            setTimeout(() => {
                game.move({ from: bestMove.substring(0, 2), to: bestMove.substring(2, 4), promotion: 'q' });
                board.position(game.fen());
                updateStatus();
                analyzePosition(game.fen()); // Analyze new position
            }, 500);
        } else if (event.data.includes('cp ')) {
            // Evaluation received
            parseEvaluation(event.data);
        }
    };
    isEngineReady = true;
    document.getElementById('status').innerHTML = "Engine Ready! Press New Game.";
});

// --- CORE FUNCTIONS ---
function init() {
    const sel = document.getElementById('openingSelect');
    for (let key in openings) {
        let opt = document.createElement('option');
        opt.value = key; opt.innerHTML = key; sel.appendChild(opt);
    }
    window.addEventListener('resize', () => { if(board) board.resize(); });
    $('#myBoard').on('touchmove', (e) => e.preventDefault());
}

function startGame() {
    if (!isEngineReady) return;
    game.reset();
    playerColor = document.getElementById('colorSelect').value;
    currentOpening = openings[document.getElementById('openingSelect').value];
    moveIndex = 0;
    prevEval = 0.3;
    
    document.getElementById('moveList').innerHTML = '';
    document.getElementById('evalBar').style.width = '50%';
    updateStatus(`<b>${currentOpening.name}</b><br>${currentOpening.desc}`);

    var config = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        orientation: playerColor,
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' // Images Fix
    };
    
    if (board) board.destroy();
    board = Chessboard('myBoard', config);

    if (playerColor === 'black') setTimeout(playComputerMove, 500);
}

function onDragStart(source, piece) {
    if (game.game_over()) return false;
    if ((playerColor === 'white' && piece.search(/^b/) !== -1) ||
        (playerColor === 'black' && piece.search(/^w/) !== -1)) return false;
}

function onDrop(source, target) {
    var move = game.move({ from: source, to: target, promotion: 'q' });
    if (move === null) return 'snapback';

    // Training Check
    checkMoveQuality(move);
    
    updateStatus();
    
    // Engine Reply
    if (!game.game_over()) {
        if (moveIndex < currentOpening.moves.length) {
             setTimeout(playComputerMove, 250);
        } else {
             // Request Move from Engine
             stockfish.postMessage('position fen ' + game.fen());
             stockfish.postMessage('go depth 5');
        }
    }
}

function onSnapEnd() { board.position(game.fen()); }

function checkMoveQuality(move) {
    let moveSan = move.san;
    let evalType = "neutral";
    let label = "";

    // 1. Book Check
    if (moveIndex < currentOpening.moves.length) {
        let expected = currentOpening.moves[moveIndex];
        if (moveSan === expected) {
            evalType = "label-best"; label = "!!";
            moveIndex++;
        } else {
            evalType = "label-inaccuracy"; label = "?!";
            updateStatus(`<b>Deviation!</b> Book: ${expected}`);
        }
    } else {
        // 2. Real Analysis (Simplified logic for demo)
        // Normally we wait for engine CP score to confirm quality
        // Here we assume neutral until eval comes back
        label = "";
    }

    // Ask engine to evaluate THIS new position to update bar
    stockfish.postMessage('position fen ' + game.fen());
    stockfish.postMessage('go depth 5');

    logMove(moveSan, evalType, label);
}

function playComputerMove() {
    if (moveIndex < currentOpening.moves.length) {
        let bookMove = currentOpening.moves[moveIndex];
        game.move(bookMove);
        board.position(game.fen());
        moveIndex++;
        logMove(bookMove, "neutral", "");
    }
}

function undoMove() {
    game.undo(); 
    if(game.turn() !== playerColor.charAt(0)) game.undo(); // Undo opponent too
    board.position(game.fen());
    // Decrement move index if we were in book
    if(moveIndex > 0) moveIndex--; 
    // Remove last 2 items from list
    let list = document.getElementById('moveList');
    if(list.childNodes.length > 0) list.removeChild(list.firstChild);
    if(list.childNodes.length > 0) list.removeChild(list.firstChild);
}

function parseEvaluation(line) {
    // Extract 'cp' (centipawn) value
    let parts = line.split(' ');
    let cpIndex = parts.indexOf('cp');
    if (cpIndex !== -1) {
        let cp = parseInt(parts[cpIndex + 1]);
        if(game.turn() === 'b') cp = -cp; // Invert for black
        
        // Update Bar (Clamp -500 to 500)
        let percentage = 50 + (cp / 10); 
        percentage = Math.max(0, Math.min(100, percentage));
        
        if(playerColor === 'black') percentage = 100 - percentage; // Flip bar for black player
        
        document.getElementById('evalBar').style.width = percentage + "%";
        
        // Detect Blunders (Shift > 200 cp)
        let delta = cp - prevEval;
        prevEval = cp;
        
        // Note: This is a simple heuristic. 
        // Real blunder detection requires comparing your move vs best move evaluation.
    }
}

function updateStatus(msg) {
    var status = msg || (game.turn() === 'b' ? 'Black' : 'White') + ' to move';
    if (game.in_check()) status += ' (Check!)';
    if (game.in_checkmate()) status = 'Checkmate!';
    document.getElementById('status').innerHTML = status;
}

function logMove(move, cssClass, symbol) {
    let list = document.getElementById('moveList');
    let li = document.createElement('li');
    li.innerHTML = `${move} <span class="${cssClass}">${symbol}</span>`;
    list.prepend(li);
}

// Events
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('undoBtn').addEventListener('click', undoMove);

init();
</script>
</body>
</html>
